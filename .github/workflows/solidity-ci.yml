name: Solidity CI with Security Testing

on:
  push:
    branches: [ main, master, sprint/* ]
  pull_request:
    branches: [ main, master ]

env:
  FOUNDRY_PROFILE: ci

jobs:
  security-and-quality:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Foundry
      uses: foundry-rs/foundry-toolchain@v1
      with:
        version: nightly

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Python and pip (for Scribble)
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        # Install npm dependencies when package.json exists
        if [ -f "package.json" ]; then
          npm ci
        fi
        # Install Scribble dependencies if needed
        pip install solc-select || echo "solc-select installation failed, continuing..."

    - name: Install Echidna
      run: |
        mkdir -p ~/.local/bin
        cd /tmp
        wget https://github.com/crytic/echidna/releases/download/v2.2.7/echidna-2.2.7-x86_64-linux.tar.gz
        tar -xzf echidna-2.2.7-x86_64-linux.tar.gz
        mv echidna ~/.local/bin/
        chmod +x ~/.local/bin/echidna
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Run Forge formatting check
      run: forge fmt --check

    - name: Run Forge build
      run: forge build

    - name: Run Forge tests
      run: forge test -vvv

    - name: Run Solhint linting
      run: make lint-solidity
      continue-on-error: true

    - name: Run Echidna property tests
      id: echidna-tests
      run: |
        echo "üîç Running Echidna property-based tests..."
        mkdir -p docs/reports
        timestamp=$(date +%Y%m%d_%H%M%S)

        # Run CI-optimized Echidna tests with timeout
        timeout 60 echidna test/echidna/SimpleTest.sol --contract SimpleTest --config echidna-ci.yaml > docs/reports/echidna-ci-$timestamp.log 2>&1 || echo "Echidna completed with timeout or warnings"

        # Store results for PR comment
        echo "ECHIDNA_RESULTS<<EOF" >> $GITHUB_OUTPUT
        echo "## üîç Echidna Property Testing Results" >> $GITHUB_OUTPUT
        echo "\`\`\`" >> $GITHUB_OUTPUT
        tail -20 docs/reports/echidna-ci-$timestamp.log >> $GITHUB_OUTPUT
        echo "\`\`\`" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Run extended fuzz testing campaign
      id: fuzz-tests
      run: |
        echo "üîç Running extended fuzz testing campaign..."
        mkdir -p docs/reports
        timestamp=$(date +%Y%m%d_%H%M%S)

        # Run CI-optimized fuzz tests with timeout
        timeout 120 forge test --match-test "fuzz" --profile ci > docs/reports/fuzz-ci-$timestamp.log 2>&1 || echo "Fuzz testing completed with timeout"

        # Store results for PR comment
        echo "FUZZ_RESULTS<<EOF" >> $GITHUB_OUTPUT
        echo "## üéØ Extended Fuzz Testing Results" >> $GITHUB_OUTPUT
        echo "\`\`\`" >> $GITHUB_OUTPUT
        tail -30 docs/reports/fuzz-ci-$timestamp.log >> $GITHUB_OUTPUT
        echo "\`\`\`" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Run Scribble specification validation
      id: scribble-tests
      run: |
        echo "üîç Running Scribble specification validation..."
        mkdir -p docs/reports
        timestamp=$(date +%Y%m%d_%H%M%S)

        # Run Scribble validation tests
        make scribble-validation-test > docs/reports/scribble-ci-$timestamp.log 2>&1 || echo "Scribble validation completed with warnings"

        # Store results for PR comment
        echo "SCRIBBLE_RESULTS<<EOF" >> $GITHUB_OUTPUT
        echo "## üìã Scribble Specification Validation Results" >> $GITHUB_OUTPUT
        echo "\`\`\`" >> $GITHUB_OUTPUT
        tail -20 docs/reports/scribble-ci-$timestamp.log >> $GITHUB_OUTPUT
        echo "\`\`\`" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Security analysis summary
      id: security-summary
      run: |
        echo "üìä Generating security analysis summary..."

        # Check for any property violations or critical issues
        SECURITY_STATUS="‚úÖ PASSED"
        if grep -r "FAIL\|ERROR\|property violation" docs/reports/ 2>/dev/null | grep -v "No such file" > /dev/null; then
          SECURITY_STATUS="‚ùå ISSUES DETECTED"
        fi

        echo "SECURITY_STATUS=$SECURITY_STATUS" >> $GITHUB_OUTPUT
        echo "SUMMARY<<EOF" >> $GITHUB_OUTPUT
        echo "# üîí Security Testing Summary" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "**Overall Status:** $SECURITY_STATUS" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "- ‚úÖ Standard Forge tests completed" >> $GITHUB_OUTPUT
        echo "- üîç Echidna property tests executed" >> $GITHUB_OUTPUT
        echo "- üéØ Extended fuzz testing performed" >> $GITHUB_OUTPUT
        echo "- üìã Scribble specification validation completed" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "_Generated at $(date)_" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const output = `${{ steps.security-summary.outputs.SUMMARY }}

          ${{ steps.echidna-tests.outputs.ECHIDNA_RESULTS }}

          ${{ steps.fuzz-tests.outputs.FUZZ_RESULTS }}

          ${{ steps.scribble-tests.outputs.SCRIBBLE_RESULTS }}

          <details>
          <summary>üìÅ Full Report Details</summary>

          All detailed reports are available in the \`docs/reports/\` directory of the CI artifacts.

          </details>`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-test-reports
        path: docs/reports/
        retention-days: 30

    - name: Fail on property violations
      run: |
        # Check for critical security property violations
        if grep -r "property violation\|CRITICAL\|FAIL.*invariant" docs/reports/ 2>/dev/null | grep -v "No such file" > /dev/null; then
          echo "‚ùå Critical property violations detected!"
          echo "Please review the security test reports and fix any violations."
          exit 1
        fi
        echo "‚úÖ No critical property violations detected."
